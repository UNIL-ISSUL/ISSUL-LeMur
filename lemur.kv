<NumericInput> :
    orientation : 'vertical'
    Label :
        text :root.name + " : " + "{:.2f}".format(root.value) + " / " + "{:.2f}".format(root.target) + " " + root.unit
        font_size : 25
        disabled : root.hidden
    Slider : 
        disabled : root.hidden
        min : root.min_value
        step : root.increment_list[1]
        max : root.max_value
        value : root.target
        on_value : root.slider_change(self.value)
    # TextInput :
    #     multiline : False
    #     size_hint_y : None
    #     height : 40 
    #     disabled : root.hidden
    #     text : "{:.2f}".format(root.target)
    #     on_text_validate : root.slider_change(float(self.text))
    BoxLayout :
        orientation : 'horizontal'
        BoxLayout :
            orientation : 'vertical'
            ToggleButton :
                allow_no_selection : False
                disabled : root.hidden
                text : str(root.increment_list[0])
                group : root.name
                on_press : root.set_increment(root.increment_list[0])
            ToggleButton : 
                allow_no_selection : False
                disabled : root.hidden
                text : str(root.increment_list[1])
                group : root.name
                state : 'down'
                on_press : root.set_increment(root.increment_list[1])
            ToggleButton :
                allow_no_selection : False
                disabled : root.hidden
                text : str(root.increment_list[2])
                group : root.name
                on_press : root.set_increment(root.increment_list[2])
        BoxLayout :
            orientation:'vertical'
            Button :
                disabled : root.hidden
                text : '-'
                on_press : root.decrease()
            Button :
                disabled : root.hidden
                text : '+'
                on_press : root.increase()
        BoxLayout :
            orientation: 'vertical'
            Button :
                text : 'SET'
                disabled : automatic_button.state == 'down' or root.hidden
                on_press : app.update_targets(root,True)
            ToggleButton :
                allow_no_selection : False
                disabled : root.hidden
                id : automatic_button
                state : 'down' if root.auto_update else 'normal'
                text : 'Mode auto' if self.state == 'down' else 'Mode manuel'
                on_press : root.toggle_auto_update(automatic_button.state)

<NumericInputCompact> :
    orientation : 'vertical'
    Label :
        text :root.name + ": " + "{:.1f}".format(root.value) + " " + root.unit
        font_size : 24
    BoxLayout : 
        orientation : 'horizontal'
        Button :
            text : "-"
            on_press : root.decrease()
        Button :
            text : "{:.1f}".format(root.value)
        Button :
            text : "+"
            on_press : root.increase()


#:import timedelta datetime.timedelta

<NumericDisplay>
    text: root.name +' : '+ "{:.2f}".format(root.value) +' '+ root.unit if not root.has_target else root.name +' : '+ "{:.2f}".format(root.value) + ' / ' + "{:.2f}".format(root.target) + '  ' + root.unit  
    #halign : 'left'
    #text_size : self.size


<StatusDisplay>
    orientation : 'horizontal'
    spacing : 10
    Led :
        #size_hint_x : 0.2
        source: 'shapes/basic_squarerounded.png'
        state : 'on' if root.active else 'off'
        id : led
    Label :
        text : root.name
        font_size : 18
        #text_size : self.size
    	valign : 'center'
    	halign : 'left'

<Controller>
    orientation : 'vertical'
    NumericDisplay :
        name : 'Inclinaison'
        unit : '°'
        value : app.treadmill_status['lift_angle_PV']
        target : app.treadmill_status['lift_angle_SP']
        has_target : True
        font_size : root.font_size
    NumericDisplay :
        name : 'Distance'
        unit : 'm'
        value : app.treadmill_status['distance_m']
        font_size : root.font_size
    NumericDisplay :
        name : app.speed_text
        unit : 'km/h'
        value : app.treadmill_status['belt_speed_PV']
        target : app.treadmill_status['belt_speed_SP']
        has_target : True
        font_size : root.font_size
    NumericDisplay
        name : 'Dénivelé'
        unit : 'm'
        value : app.treadmill_status['elevation_m']
        font_size : root.font_size
    NumericDisplay :
        name : 'Vitesse verticale'
        unit : 'm/h'
        value : app.treadmill_status['vertical_speed_PV']
        target : app.treadmill_status['vertical_speed_SP']
        has_target : True
        font_size : root.font_size
    Label : 
        text : 'Durée : ' + str(timedelta(seconds=app.treadmill_status['elapsed_time'])).split('.', 2)[0]
        font_size : root.font_size

    ToggleButton :
        allow_no_selection : False
        id : start
        text : 'Start'
        group : 'controller'
        on_press : app.start(self)
        font_size : root.font_size
    ToggleButton : 
        allow_no_selection : False
        id : pause
        text : 'Pause'
        group : 'controller'
        on_press : app.pause(self)
        font_size : root.font_size
    ToggleButton : 
        allow_no_selection : False
        id : stop
        text : 'Stop'
        state : 'down'
        group : 'controller'
        on_press : app.stop(self)
        font_size : root.font_size

<Status@BoxLayout> :
    orientation : 'horizontal'
    spacing : 10
    StatusDisplay :
        name : 'Sécurité gauche'
        active : app.safety_left
    StatusDisplay :
        name : 'Sécurité droit'
        active : app.safety_right
    StatusDisplay :
        name : 'Sécurité avant'
        active : app.safety_front
    StatusDisplay :
        name : 'Sécurité arrière'
        active : app.safety_back
    StatusDisplay :
        name : 'Arret urgence'
        active : app.safety_emergency

#Manual Windows
<ManualWidget@BoxLayout>:

    orientation : 'vertical'
    padding : 10
    spacing : 10
    id : main

    Label :
        text : 'Controle de la vitesse verticale :'
        size_hint_y : 0.1
        font_size : 24

    BoxLayout :
        orientation : 'horizontal'
        size_hint_y : 0.1
        spacing : 10
        ToggleButton :
            allow_no_selection : False
            text : 'Aucun'
            group : 'vertical_speed'
            state : 'down'
            on_press : app.mode_changed(self)
        ToggleButton :
            allow_no_selection : False
            text : 'Inclinaison'
            group : 'vertical_speed'
            on_press : app.mode_changed(self)
        ToggleButton :
            allow_no_selection : False
            text : 'Vitesse tapis'
            group : 'vertical_speed'
            on_press : app.mode_changed(self)

    GridLayout :
        cols : 1
        spacing : 10
        padding : 0

        NumericInput :
            id : tilt
            target : app.tilt_target
            value : app.treadmill_status['lift_angle_PV']
            on_target : app.update_targets(tilt)
            name : 'Inclinaison'
            unit : '°'
            min_value : 1   #limité par le l'axe des poulies des courroies
            max_value : 40  #limité par le l'axe des poulies des courroies
            auto_update : False
        
        NumericInput :
            id : belt_speed
            value : app.treadmill_status['belt_speed_PV']
            target : app.belt_speed_target
            on_target : app.update_targets(belt_speed)
            name : app.speed_text
            unit : 'km/h'
            min_value : 0
            max_value : 15
            auto_update : True

        NumericInput :
            id : vertical_speed
            hidden : True
            target : app.vertical_speed_target
            value : app.treadmill_status['vertical_speed_PV']
            on_target : app.update_targets(vertical_speed)
            name : 'Vitesse verticale'
            unit : 'm/h'
            min_value : 100
            max_value : 3500
            auto_update : True
            increment_list : [10, 50, 100]

    BoxLayout : 
        orientation : 'vertical'
        canvas.before:
            Color:
                rgba: (204/255, 82/255, 0/255,1) if app.steps_active else (0, 0, 0, 1)
            Rectangle:
                pos: self.pos
                size: self.size
        
        size_hint_y : 0.3
        padding : [0,0,0,20]

        Label :
            text : 'Surface de marche'
            font_size : 24
        BoxLayout :
            orientation : 'horizontal'
            spacing : 10
            ToggleButton :
                allow_no_selection : False
                text : 'Bande'
                group : 'steps'
                state : 'down'
                on_press : app.toggle_steps(False)
            ToggleButton :
                allow_no_selection : False
                text : 'Marches'
                group : 'steps'
                on_press : app.toggle_steps(True)

<MainScreenManager>:
    id: screen_manager

    Screen:
        name: "manual_tab"
        ManualWidget:
            id: manual_widget

    Screen:
        name: "incremental_tab"
        IncrementalWidget:
            id: incr_widget

 

BoxLayout :
    orientation: 'horizontal'
    padding : 10
    spacing : 10

    #Section principale
    BoxLayout
        orientation: "vertical"
        # --- Barre d'onglets ---
        BoxLayout:
            size_hint_y: None
            height: "40dp"

            ToggleButton:
                allow_no_selection : False
                text: "Contrôle manuel"
                group: "tabs"
                state: "down"
                on_release: screen_manager.current = "manual_tab"

            ToggleButton:
                allow_no_selection : False
                text: "Test incrémental"
                group: "tabs"
                on_release: screen_manager.current = "incremental_tab"

        # --- Contenu des onglets ---
        MainScreenManager:
            id: screen_manager

    # Séparateur visuel
    Widget:
        size_hint_x: None
        width: 5
        canvas:
            Color:
                rgba: 0.7, 0.7, 0.7, 1  # couleur grise
            Rectangle:
                pos: self.pos
                size: self.size

    #pSection de droite  
    BoxLayout:
        orientation : 'vertical'
        size_hint_x : 0.35

        TreadmillLayout:
            id: treadmill
            font_size: 24
            safeties : app.treadmill_status['safeties']
            mode_belt : app.steps_active

        Controller :
            id : controller
            font_size : 50
